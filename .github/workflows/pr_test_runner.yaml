name: PR Test Runner

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.12.3'

    - name: Install pipenv
      run: |
        python -m pip install --upgrade pip
        pip install pipenv

    - name: Generate requirements.txt
      run: |
        pipenv lock -r > requirements.txt

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Parse branch name
      id: parse-branch
      run: |
        branch_name="${{ github.head_ref }}"
        parsed_name=$(echo $branch_name | sed -E 's/^req-#([0-9]+)-(.*)$/req_\1_\2/' | tr '[:upper:]-' '[:lower:]_')
        echo "PARSED_BRANCH_NAME=$parsed_name" >> $GITHUB_ENV

    - name: Run pytest
      id: pytest
      run: |
        pytest_output=$(pytest -v -m ${{ env.PARSED_BRANCH_NAME }})
        echo "PYTEST_OUTPUT<<EOF" >> $GITHUB_ENV
        echo "$pytest_output" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        if [ $? -ne 0 ]; then
          echo "PYTEST_FAILED=true" >> $GITHUB_ENV
        else
          echo "PYTEST_FAILED=false" >> $GITHUB_ENV
        fi

    - name: Comment PR
      uses: actions/github-script@v6
      if: always()
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const { owner, repo } = context.repo;
          const issue_number = context.issue.number;
          
          const output = `#### Pytest Results üß™
          \`\`\`
          ${{ env.PYTEST_OUTPUT }}
          \`\`\`
          
          **Result:** ${process.env.PYTEST_FAILED === 'true' ? '‚ùå Failed' : '‚úÖ Passed'}`;
          
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number,
            body: output
          });

    - name: Check test results
      if: failure()
      run: |
        echo "Tests failed. Please check the test output above."